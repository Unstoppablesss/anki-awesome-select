<script>
  // v0.5.2 - https://github.com/SimonLammer/anki-persistence/blob/62463a7f63e79ce12f7a622a8ca0beb4c1c5d556/script.js
  if(void 0===window.Persistence){var _persistenceKey="github.com/SimonLammer/anki-persistence/",_defaultKey="_default";if(window.Persistence_sessionStorage=function(){var e=!1;try{"object"==typeof window.sessionStorage&&(e=!0,this.clear=function(){for(var e=0;e<sessionStorage.length;e++){var t=sessionStorage.key(e);0==t.indexOf(_persistenceKey)&&(sessionStorage.removeItem(t),e--)}},this.setItem=function(e,t){void 0==t&&(t=e,e=_defaultKey),sessionStorage.setItem(_persistenceKey+e,JSON.stringify(t))},this.getItem=function(e){return void 0==e&&(e=_defaultKey),JSON.parse(sessionStorage.getItem(_persistenceKey+e))},this.removeItem=function(e){void 0==e&&(e=_defaultKey),sessionStorage.removeItem(_persistenceKey+e)})}catch(e){}this.isAvailable=function(){return e}},window.Persistence_windowKey=function(e){var t=window[e],i=!1;"object"==typeof t&&(i=!0,this.clear=function(){t[_persistenceKey]={}},this.setItem=function(e,i){void 0==i&&(i=e,e=_defaultKey),t[_persistenceKey][e]=i},this.getItem=function(e){return void 0==e&&(e=_defaultKey),t[_persistenceKey][e]||null},this.removeItem=function(e){void 0==e&&(e=_defaultKey),delete t[_persistenceKey][e]},void 0==t[_persistenceKey]&&this.clear()),this.isAvailable=function(){return i}},window.Persistence=new Persistence_sessionStorage,Persistence.isAvailable()||(window.Persistence=new Persistence_windowKey("py")),!Persistence.isAvailable()){var titleStartIndex=window.location.toString().indexOf("title"),titleContentIndex=window.location.toString().indexOf("main",titleStartIndex);titleStartIndex>0&&titleContentIndex>0&&titleContentIndex-titleStartIndex<10&&(window.Persistence=new Persistence_windowKey("qt"))}}
</script>

<div class="wrap-container">
  <div class="body">
    <div class="question">{{id}}.<span id="questionType" class="question-type"> </span>{{cloze:question}}</div>
    <div class="options" id="optionFront"></div>
    <div id="tagFront"></div>
  </div>
</div>

<div class="footer">v3.8，作者：git9527，<a href="javascript:showSettings();">卡片设置</a>，开源地址：<a href="https://github.com/git9527/anki-awesome-select">Github</a> | <a href="https://gitee.com/git9527/anki-awesome-select">Gitee</a></div>

<div id="answer" style="display:none">{{answer}}</div>
<div id="options" style="display:none">{{options}}</div>
<div id="tags" style="display:none">{{Tags}}</div>

<div id="settingsModal" class="modal">

  <div class="modal-content">
    <span class="close" onclick="hideSettings()">&times;</span>
    <div class="settings-block">
      <div class="single-setting">
        <div class="setting-label">显示类型</div>
        <div class="setting-switch">
          <input id="show-type" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchShowType(this)">
        </div>
      </div>
      <div class="single-setting">
        <div class="setting-label">隐藏选项</div>
        <div class="setting-switch">
          <input id="hide-option" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchHideOption(this)">
        </div>
      </div>
      <div class="single-setting">
        <div class="setting-label">随机选项</div>
        <div class="setting-switch">
          <input id="random-option" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchRandomOption(this)">
        </div>
      </div>
      <div class="single-setting">
        <div class="setting-label">延迟选项</div>
        <div class="setting-switch">
          <input id="delay-option" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchDelayOption(this)">
        </div>
      </div>
      <div class="single-setting">
        <div class="setting-label">纯色模式</div>
        <div class="setting-switch">
          <input id="normal-option" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchNormalOption(this)">
        </div>
      </div>
      <div class="single-setting">
        <div class="setting-label">隐藏解析</div>
        <div class="setting-switch">
          <input id="hide-notes" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchHideNotes(this)">
        </div>
      </div>
    </div>
  </div>

</div>

<script>

  var showQuestionType = '0'
  var hideOptions = '0'
  var randomOptions = '0'
  var delayOptions = '0'
  var normalOption = '0'
  var hideNotes = '0'

  function showFrontOptions(hideOption, randomOption, delayOption) {
    var keySeq = []
    var optionObjs = getOptionObjs(randomOption)
    initEmptyOptionList(optionObjs)
    var liList = ''
    for (var i in optionObjs) {
      var _optionObj = optionObjs[i]
      var _option = _optionObj.label
      if (hideOption === '1') {
        var endIndex = _optionObj.label.indexOf("《") > -1 ? 2 : 1
        _option = _optionObj.label.substring(0, endIndex)
      }
      liList += "<li id='" + _optionObj.key + "' class='option' onclick='markSelected(this)'>" + _option + "</li>"
      keySeq.push(_optionObj.key)
    }
    if (Persistence.isAvailable()) {
      Persistence.setItem('ANKI-OPTIONS-ORDER', keySeq.toString())
    }
    if (delayOption === '1') {
      setTimeout(function () {
        document.getElementById("optionFront").innerHTML = liList
      }, 1500)
    } else {
      document.getElementById("optionFront").innerHTML = liList
    }
  }

  function initEmptyOptionList(optionObjs) {
    var liList = ''
    for (var i in optionObjs) {
      liList += "<li class='option'></li>"
    }
    document.getElementById("optionFront").innerHTML = liList
  }

  function getOptionObjs(randomOption) {
    var optionArray = document.getElementById("options").innerHTML.trim().split("||")
    var optionObjs = []
    for (var i in optionArray) {
      optionObjs.push({
        key: Number.parseInt(i) + 1,
        label: optionArray[i]
      })
    }
    if (randomOption === '1') {
      for (let i = 1; i < optionObjs.length; i++) {
        const random = Math.floor(Math.random() * (i + 1))
        const temp = optionObjs[i]
        optionObjs[i] = optionObjs[random]
        optionObjs[random] = temp
      }
    }
    return optionObjs
  }

  function getSelectedKey() {
    return normalOption === '1' ? 'selected' : 'selected-light'
  }

  function markSelected(li) {
    var selectedKey = getSelectedKey()
    // 对应多选
    if (document.getElementById("answer").innerHTML.indexOf('||') > 0) {
      if (Persistence.isAvailable()) {
        var selectedArray = Persistence.getItem('ANKI-SELECTED') ? Persistence.getItem('ANKI-SELECTED').split(',') : []
        if (li.className.indexOf(selectedKey) > 0) {
          selectedArray.splice(selectedArray.indexOf(li.id), 1)
        } else {
          selectedArray.push(li.id)
        }
        selectedArray.sort()
        Persistence.setItem('ANKI-SELECTED', selectedArray.toString())
        if (selectedArray.length === document.getElementById("answer").innerHTML.trim().split('||').length) {
          setTimeout(function () {
            flipToBack()
          }, 100)
        }
      }
      if (li.className.indexOf(selectedKey) > 0) {
        li.className = "option"
      } else {
        li.className = "option " + selectedKey
      }
    } else {
      // 单选
      for (var option of document.getElementsByClassName('option')) { option.className = 'option'}
      li.className = "option " + selectedKey
      if (Persistence.isAvailable()) {
        Persistence.setItem('ANKI-SELECTED', li.id)
      }
      setTimeout(function () {
        flipToBack()
      }, 100)
    }
  }

  function flipToBack () {
    if (typeof pycmd !== "undefined") {
      pycmd("ans")
    } else if (typeof study !== "undefined") {
      study.drawAnswer()
    } else if (typeof AnkiDroidJS !== "undefined") {
      showAnswer()
    } else if (window.anki && window.sendMessage2) {
      window.sendMessage2("ankitap", "midCenter")
    }
  }

  function showTags () {
    var tags = document.getElementById("tags").innerHTML
    if (!tags) return
    tags = tags.split(' ')
    var tagList = '<span class="tag-title">标签: </span>'
    for (var tag of tags) {
      if (tag) {
        tagList += '<span class="single-tag">' + tag + '</span>'
      }
    }
    document.getElementById("tagFront").innerHTML = tagList
  }

  function showSettings() {
    document.getElementById("settingsModal").style.display = 'block'
  }

  function hideSettings() {
    document.getElementById("settingsModal").style.display = 'none'
  }

  function renameIOsSendMessage(){
    if (window['sendMessage']) {
      window['sendMessage2'] = window['sendMessage']
      window['sendMessage'] = null
    }
  }

  function applySettings() {
    if (Persistence.isAvailable()) {
      showQuestionType = Persistence.getItem('ANKI-SETTINGS-SHOW-QUESTION-TYPE') || '0'
      hideOptions = Persistence.getItem('ANKI-SETTINGS-HIDE-OPTIONS') || '0'
      randomOptions = Persistence.getItem('ANKI-SETTINGS-RANDOM-OPTIONS') || '0'
      delayOptions = Persistence.getItem('ANKI-SETTINGS-DELAY-OPTIONS') || '0'
      normalOption = Persistence.getItem('ANKI-SETTINGS-NORMAL-OPTIONS') || '0'
      hideNotes = Persistence.getItem('ANKI-SETTINGS-HIDE-NOTES') || '0'
      Persistence.setItem('ANKI-SELECTED', '')
    }
    document.getElementById('hide-option').checked = hideOptions === '1'
    document.getElementById('random-option').checked = randomOptions === '1'
    document.getElementById('show-type').checked = showQuestionType === '1'
    document.getElementById('delay-option').checked = delayOptions === '1'
    document.getElementById('normal-option').checked = normalOption === '1'
    document.getElementById('hide-notes').checked = hideNotes === '1'
    showFrontOptions(hideOptions, randomOptions, delayOptions)
    dealQuestionType(showQuestionType)
  }

  function switchHideOption(input) {
    rerenderOptions(input, 'ANKI-SETTINGS-HIDE-OPTIONS')
  }

  function switchDelayOption(input) {
    rerenderOptions(input, 'ANKI-SETTINGS-DELAY-OPTIONS')
  }

  function switchRandomOption(input) {
    rerenderOptions(input, 'ANKI-SETTINGS-RANDOM-OPTIONS')
  }

  function switchNormalOption(input) {
    extractKeyFromInputAndSave(input, 'ANKI-SETTINGS-NORMAL-OPTIONS')
    var selectedKey = getSelectedKey()
    for (var option of document.getElementsByClassName('option')) {
      if (option.className.indexOf(' ') > -1) {
        option.className = "option " + selectedKey
      }
    }
  }

  function switchHideNotes(input) {
    extractKeyFromInputAndSave(input, 'ANKI-SETTINGS-HIDE-NOTES')
  }

  function switchShowType(input) {
    extractKeyFromInputAndSave(input, 'ANKI-SETTINGS-SHOW-QUESTION-TYPE')
    dealQuestionType(showQuestionType)
  }

  function extractKeyFromInputAndSave(input, persistKey) {
    var key = input.checked ? '1' : '0'
    if (Persistence.isAvailable()) {
      Persistence.setItem(persistKey, key)
      if (persistKey === 'ANKI-SETTINGS-RANDOM-OPTIONS' || persistKey === 'ANKI-SETTINGS-DELAY-OPTIONS' || persistKey === 'ANKI-SETTINGS-HIDE-OPTIONS') {
        Persistence.setItem('ANKI-SELECTED', '')
      }
    }
    if (persistKey === 'ANKI-SETTINGS-HIDE-OPTIONS') {
      hideOptions = key
    } else if (persistKey === 'ANKI-SETTINGS-DELAY-OPTIONS') {
      delayOptions = key
    } else if (persistKey === 'ANKI-SETTINGS-RANDOM-OPTIONS') {
      randomOptions = key
    } else if (persistKey === 'ANKI-SETTINGS-NORMAL-OPTIONS') {
      normalOption = key
    } else if (persistKey === 'ANKI-SETTINGS-SHOW-QUESTION-TYPE') {
      showQuestionType = key
    } else if (persistKey === 'ANKI-SETTINGS-HIDE-NOTES') {
      hideNotes = key
    }
    return key
  }

  function rerenderOptions(input, persistKey) {
    extractKeyFromInputAndSave(input, persistKey)
    showFrontOptions(hideOptions, randomOptions, delayOptions, normalOption)
  }

  function dealQuestionType(showQuestionType) {
    if (showQuestionType === '1') {
      document.getElementById('questionType').innerHTML = document.getElementById("answer").innerHTML.indexOf('||') > -1 ? '【多选】' : '【单选】'
    } else {
      document.getElementById('questionType').innerHTML = ' '
    }
  }

  applySettings()
  showTags()
  renameIOsSendMessage()

</script>
