<script>
  // v0.5.2 - https://github.com/SimonLammer/anki-persistence/blob/62463a7f63e79ce12f7a622a8ca0beb4c1c5d556/script.js
  if(void 0===window.Persistence){var _persistenceKey="github.com/SimonLammer/anki-persistence/",_defaultKey="_default";if(window.Persistence_sessionStorage=function(){var e=!1;try{"object"==typeof window.sessionStorage&&(e=!0,this.clear=function(){for(var e=0;e<sessionStorage.length;e++){var t=sessionStorage.key(e);0==t.indexOf(_persistenceKey)&&(sessionStorage.removeItem(t),e--)}},this.setItem=function(e,t){void 0==t&&(t=e,e=_defaultKey),sessionStorage.setItem(_persistenceKey+e,JSON.stringify(t))},this.getItem=function(e){return void 0==e&&(e=_defaultKey),JSON.parse(sessionStorage.getItem(_persistenceKey+e))},this.removeItem=function(e){void 0==e&&(e=_defaultKey),sessionStorage.removeItem(_persistenceKey+e)})}catch(e){}this.isAvailable=function(){return e}},window.Persistence_windowKey=function(e){var t=window[e],i=!1;"object"==typeof t&&(i=!0,this.clear=function(){t[_persistenceKey]={}},this.setItem=function(e,i){void 0==i&&(i=e,e=_defaultKey),t[_persistenceKey][e]=i},this.getItem=function(e){return void 0==e&&(e=_defaultKey),t[_persistenceKey][e]||null},this.removeItem=function(e){void 0==e&&(e=_defaultKey),delete t[_persistenceKey][e]},void 0==t[_persistenceKey]&&this.clear()),this.isAvailable=function(){return i}},window.Persistence=new Persistence_sessionStorage,Persistence.isAvailable()||(window.Persistence=new Persistence_windowKey("py")),!Persistence.isAvailable()){var titleStartIndex=window.location.toString().indexOf("title"),titleContentIndex=window.location.toString().indexOf("main",titleStartIndex);titleStartIndex>0&&titleContentIndex>0&&titleContentIndex-titleStartIndex<10&&(window.Persistence=new Persistence_windowKey("qt"))}}
</script>

<div class="wrap-container">
  <div class="body">
    <div class="question">{{id}}.<span id="questionType" class="question-type"></span>{{cloze:question}}</div>
    <div class="options" id="optionFront"></div>
    <div id="tagFront"></div>
  </div>
</div>

<div class="footer">v3.0，作者：git9527，<a href="javascript:showSettings();">卡片设置</a>，开源地址：<a href="https://github.com/git9527/anki-awesome-select">Github</a> | <a href="https://gitee.com/git9527/anki-awesome-select">Gitee</a></div>

<div id="answer" style="display:none">{{answer}}</div>
<div id="options" style="display:none">{{options}}</div>
<div id="tags" style="display:none">{{Tags}}</div>

<div id="settingsModal" class="modal">

  <div class="modal-content">
    <span class="close" onclick="hideSettings()">&times;</span>
    <div class="settings-block">
      <div class="single-setting">
        <div class="setting-label">隐藏选项</div>
        <div class="setting-switch">
          <input id="hide-option" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchHideOption(this)">
        </div>
      </div>
      <div class="single-setting">
        <div class="setting-label">随机选项</div>
        <div class="setting-switch">
          <input id="random-option" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchRandomOption(this)">
        </div>
      </div>
      <div class="single-setting">
        <div class="setting-label">显示类型</div>
        <div class="setting-switch">
          <input id="show-type" class="mui-switch mui-switch-anim" type="checkbox" onchange="switchShowType(this)">
        </div>
      </div>
    </div>
  </div>

</div>

<script>

  var showQuestionType = '0'
  var hideOptions = '0'
  var randomOptions = '0'

  function showFrontOptions(hideOption, randomOption) {
    var keySeq = []
    var optionObjs = getOptionObjs(randomOption)
    var liList = ''
    for (var i in optionObjs) {
      var _optionObj = optionObjs[i]
      var prefix = String.fromCharCode(Number.parseInt(i) + 65)
      var _option = prefix + '. ' + _optionObj.label
      if (hideOption === '1') {
        var endIndex = _optionObj.label.indexOf("《") > -1 ? 2 : 1
        _option = prefix + '. ' + _optionObj.label.substring(0, endIndex)
      }
      liList += "<li id='" + _optionObj.key + "' class='option' onclick='markSelected(this)'>" + _option + "</li>"
      keySeq.push(_optionObj.key)
    }
    if (Persistence.isAvailable()) {
      Persistence.setItem('ANKI-OPTIONS-ORDER', keySeq.toString())
    }
    document.getElementById("optionFront").innerHTML = liList
  }

  function getOptionObjs(randomOption) {
    var optionArray = document.getElementById("options").innerHTML.trim().split("||")
    var optionObjs = []
    for (var i in optionArray) {
      optionObjs.push({
        key: Number.parseInt(i) + 1,
        label: optionArray[i]
      })
    }
    if (randomOption === '1') {
      for (let i = 1; i < optionObjs.length; i++) {
        const random = Math.floor(Math.random() * (i + 1))
        const temp = optionObjs[i]
        optionObjs[i] = optionObjs[random]
        optionObjs[random] = temp
      }
    }
    return optionObjs
  }

  function markSelected(li) {
    // 对应多选
    if (document.getElementById("answer").innerHTML.indexOf('||') > 0) {
      if (Persistence.isAvailable()) {
        var selectedArray = Persistence.getItem('ANKI-SELECTED') ? Persistence.getItem('ANKI-SELECTED').split(',') : []
        if (li.className.indexOf("selected") > 0) {
          selectedArray.splice(selectedArray.indexOf(li.id), 1)
        } else {
          selectedArray.push(li.id)
        }
        selectedArray.sort()
        Persistence.setItem('ANKI-SELECTED', selectedArray.toString())
        if (selectedArray.length === document.getElementById("answer").innerHTML.trim().split('||').length) {
          setTimeout(function () {
            flipToBack()
          }, 100)
        }
      }
      if (li.className.indexOf("selected") > 0) {
        li.className = "option"
      } else {
        li.className = "option selected"
      }
    } else {
      // 单选
      for (var option of document.getElementsByClassName('option')) { option.className = 'option'}
      li.className = "option selected"
      if (Persistence.isAvailable()) {
        Persistence.setItem('ANKI-SELECTED', li.id)
      }
      setTimeout(function () {
        flipToBack()
      }, 100)
    }
  }

  function flipToBack () {
    if (typeof pycmd !== "undefined") {
      pycmd("ans")
    } else if (typeof study !== "undefined") {
      study.drawAnswer()
    } else if (typeof AnkiDroidJS !== "undefined") {
      showAnswer()
    } else if (window.anki && window.sendMessage2) {
      window.sendMessage2("ankitap", "midCenter")
    }
  }

  function showTags () {
    var tags = document.getElementById("tags").innerHTML
    if (!tags) return
    tags = tags.split(' ')
    var tagList = '<span class="tag-title">标签: </span>'
    for (var tag of tags) {
      if (tag) {
        tagList += '<span class="single-tag">' + tag + '</span>'
      }
    }
    document.getElementById("tagFront").innerHTML = tagList
  }

  function showSettings() {
    document.getElementById("settingsModal").style.display = 'block'
  }

  function hideSettings() {
    document.getElementById("settingsModal").style.display = 'none'
  }

  function renameIosSendMessage(){
    if (window['sendMessage']) {
      window['sendMessage2'] = window['sendMessage']
      window['sendMessage'] = null
    }
  }

  function applySettings() {
    if (Persistence.isAvailable()) {
      showQuestionType = Persistence.getItem('ANKI-SETTINGS-SHOW-QUESTION-TYPE') || '0'
      hideOptions = Persistence.getItem('ANKI-SETTINGS-HIDE-OPTIONS') || '0'
      randomOptions = Persistence.getItem('ANKI-SETTINGS-RANDOM-OPTIONS') || '0'
    }
    document.getElementById('hide-option').checked = hideOptions === '1'
    document.getElementById('random-option').checked = randomOptions === '1'
    document.getElementById('show-type').checked = showQuestionType === '1'
    showFrontOptions(hideOptions, randomOptions)
    dealQuestionType(showQuestionType)
  }

  function switchHideOption(input) {
    var key = input.checked ? '1' : '0'
    if (Persistence.isAvailable()) {
      Persistence.setItem('ANKI-SETTINGS-HIDE-OPTIONS', key)
    }
    showFrontOptions(key, randomOptions)
  }

  function switchRandomOption(input) {
    var key = input.checked ? '1' : '0'
    if (Persistence.isAvailable()) {
      Persistence.setItem('ANKI-SETTINGS-RANDOM-OPTIONS', key)
    }
    showFrontOptions(hideOptions, key)
  }

  function switchShowType(input) {
    var key = input.checked ? '1' : '0'
    if (Persistence.isAvailable()) {
      Persistence.setItem('ANKI-SETTINGS-SHOW-QUESTION-TYPE', key)
    }
    dealQuestionType(key)
  }

  function dealQuestionType(showQuestionType) {
    if (showQuestionType === '1') {
      document.getElementById('questionType').innerHTML = document.getElementById("answer").innerHTML.indexOf('||') > -1 ? '【多选】' : '【单选】'
    } else {
      document.getElementById('questionType').innerHTML = ' '
    }
  }

  applySettings()
  showTags()
  renameIosSendMessage()
</script>
